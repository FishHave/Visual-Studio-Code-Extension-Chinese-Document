# 自定义编辑器

自定义编辑器允许扩展创建可自定义替代VS Code标准文本编辑器读写编辑器，它们为特定资源类型服务。它们有广泛的使用情形，比如：

- 直接在VS Code中预览资产，如着色器或3D模型
- 为如CSV或JSON或XML之类的语言创建所见即所得编辑器
- 为如CSV或JSON或XML之类的数据文件提供可视化渲染的替代品
- 为二进制或文本文件构建完全可自定义的编辑体验

这篇文档提供关于自定义编辑器API和实现自定义编辑器基础的概览。我们将关注两种自定义编辑器和它们的不同之处，以及您的需求适合哪个。然后对于每种自定义编辑器类型，我们会介绍构建良好自定义编辑器的基础

尽管自定义编辑器是一个强大的新扩展点，实现一个基础自定义编辑器实际上并不是那么难！如果您仍然在编辑您的第一个VS Code扩展，在您更熟悉VS Code API基础前，您也许要考虑推迟深入探究自定义编辑器。自定义编辑器以许多VS Code概念为基础——比如[Web视图](7.%20Web视图.md)和文本文档——所以如果您在同时学习这些新点子，它可能有些令人不知所措

但是如果您觉得准备好了并且在想关于您要构建的所有酷炫的自定义编辑器，那么让我们开始吧！确保下载[自定义编辑器扩展示例](https://github.com/microsoft/vscode-extension-samples/tree/main/custom-editor-sample)，这样您可以跟随文档并看看自定义编辑器API如何工作

## 链接

- [自定义编辑器示例](https://github.com/microsoft/vscode-extension-samples/tree/main/custom-editor-sample)

### VS Code API用法

- [`window.registerCustomEditorProvider`](/9.%20参考/1.%20VS%20Code%20API.md#window)
- [`CustomTextEditorProvider`](/9.%20参考/1.%20VS%20Code%20API.md#CustomTextEditorProvider)

## 自定义编辑器API基础

自定义编辑器是在VS Code标准文本编辑器中显示的视图替代，它用于特定资源。自定义编辑器有两部分：用户互动的视图和扩展用来与底层互动的文档模型

自定义编辑器的视图部分使用[Web视图](7.%20Web视图.md)实现。这允许您用标准HTML、CSS和JavaScript构建自定义编辑器的用户界面。Web视图不能直接访问VS Code API但是可以通过来回传递消息与扩展对话。查阅我们的[Web视图文档](7.%20Web视图.md)以了解更多Web视图信息和实践

自定义编辑器的另一部分是文档模型。这个模型是您的扩展如何理解处理的资源（文件）。`CustomTextEditorProvider`使用VS Code标准[TextDocument](/9.%20参考/1.%20VS%20Code%20API.md#workspace)作为它的文档模型，并且所有的文件更改使用VS Code标准文本编辑API表达。另一方面，`CustomReadonlyEditorProvider`和`CustomEditorProvider`允许您提供您自己的非文本文件格式文档模型

自定义编辑器对于每个资源拥有简单的文档模型，但是也许会存在多个文档编辑器实例（视图）。例如，假如您打开一个拥有`CustomTextEditorProvider`的文件，然后运行**View: Split editor（查看：拆分编辑器）**命令。这种情况下，仍然只有单个`TextDocument`，因为仍然只有单个工作空间资源的复制，但是现在有两个对于那个资源的Web视图

### CustomEditor 对比 CustomTextEditor

存在两个自定义编辑器类：自定义文本编辑器和自定义编辑器。主要的不同在于它们如何定义文档模型

`CustomTextEditorProvider`使用VS Code标准`TextDocument`作为数据模型。您可以为任何基于文本的文件类型使用`CustomTextModel`。`CustomTextEditor`相当简单实现，因为VS Code已经知道如何处理文本文件，因此可以实现诸如保存和为强制退出备份文件等操作

另一方面，使用`CustomEditorProvider`，您的扩展使用自己的文档模型。这意味着您可以使用一个如图像的二进制格式`CustomEditor`，但同样表明您的扩展工程量更大，包括实现保存和备份。如果您的自定义编辑器只读，您可以避免这些杂事，比如预览编辑器。

### 贡献点

`customEditors`[贡献点](/9.%20参考/2.%20贡献点.md)是关于您的扩展如何告诉VS Code它提供的自定义编辑器。例如，VS Code需要知道您的自定义编辑器处理的文件类型和如何在UI中定义您的自定义编辑器

这是个[自定义编辑器扩展示例](https://github.com/microsoft/vscode-extension-samples/tree/main/custom-editor-sample)中的基本`customEditor`贡献点：
```json
"contributes": {
  "customEditors": [
    {
      "viewType": "catEdit.catScratch",
      "displayName": "Cat Scratch",
      "selector": [
        {
          "filenamePattern": "*.cscratch"
        }
      ],
      "priority": "default"
    }
  ]
}
```

`customEditors`是个数组，所以您的扩展可以贡献多个自定义编辑器。让我们分解自定义编辑器项自身：

- `viewType` - 您的自定义编辑器独有的标识符。
    这是VS Code绑定`package.json`中的自定义编辑器贡献点和您代码中自定义编辑器的实现。这必须在全扩展中独一无二，所以与其使用常用如`preview`的`viewType`，不如确保使用您扩展中独特如`myAmazingExtension.svgPreview`的`viewType`
- `displayName` - 在VS Code UI中识别自定义编辑器的名称
    显示名称在VS Code UI中显示，比如**View: Reopen with（查看：重新打开）**下拉菜单
- `selector` - 指定自定义编辑器启用的文件
    `selector`是一个或多个[通配符表达式](https://code.visualstudio.com/docs/editor/glob-patterns)。这些通配符表达式匹配文件名来决定自定义编辑器是否要为它们启用。如`*.png`的`filenamePattern`将为所有PNG文件启用自定义编辑器
    
    您同样可以创建更多特定表达式匹配文件名或文件夹名，例如`**/translations/*.json`

- `priority` - （可选）指定自定义编辑器什么时候使用
    `priority`控制当资源打开时，自定义编辑器什么时候使用。可能的值为：
        - `"default"` - 尝试为所有匹配自定义编辑器`selector`的文件使用自定义编辑器。如果指定的文件多个自定义编辑器，用户必须选择他们想要使用的自定义编辑器
        - `"option"` - 不要默认使用自定义编辑器但允许用户切换或配置为默认

### 自定义编辑器启用

当用户打开自定义编辑器中的一个时，VS Code出发`onCustomEditor.VIEW_TYPE`启用事件。在启用时，您的扩展必须调用`registerCustomEditorProvider`来使用期望的`viewType`注册自定义编辑器

重要的是，要注意`onCustomEditor`只能在VS Code需要创建您的自定义编辑器实例时调用。如果VS Code仅仅显示用户一些关于可用自定义编辑器的信息——如使用**View: Reopen with（查看：重新打开）**命令——您的扩展不会被启用

## 自定义文本编辑器

自定义文本编辑器允许您创建文本文件自定义编辑器。这可以是从普通无结构文本到[CSV](https://en.wikipedia.org/wiki/Comma-separated_values)或JSON、XML。自定义编辑器使用VS Code标准[TextDocument](/9.%20参考/1.%20VS%20Code%20API.md#TextDocument)作为它们的文档模型

[自定义编辑器扩展示例](https://github.com/microsoft/vscode-extension-samples/tree/main/custom-editor-sample)包括一个简单的示例自定义文本编辑器，它用于Cat Scratch文件（后缀`.csratch`文件扩展的JSON文件）。让我们看一看实现一个自定义文本编辑器的重要部分

### 自定义文本编辑器生命周期

